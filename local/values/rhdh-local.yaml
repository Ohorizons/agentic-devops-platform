# =============================================================================
# THREE HORIZONS ACCELERATOR — RHDH Local Values Override
# =============================================================================
# Supports TWO authentication modes:
#
#   1. GUEST MODE (default) — No GitHub App required, instant access.
#      Just set RHDH_ENABLED=true in local/config/local.env
#
#   2. GITHUB APP MODE — Full GitHub integration with catalog discovery,
#      scaffolding, and org-based auth.
#      Set these in local/config/local.env:
#        RHDH_AUTH_MODE="github"
#        GITHUB_APP_ID="..."
#        GITHUB_APP_CLIENT_ID="..."
#        GITHUB_APP_CLIENT_SECRET="..."
#        GITHUB_APP_PRIVATE_KEY_FILE="/path/to/private-key.pem"
#
# Requires: registry.redhat.io pull credentials (free developer account).
# Enable with: RHDH_ENABLED=true in local/config/local.env
# =============================================================================

upstream:
  backstage:
    replicas: 1

    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi

    # -- Extra environment variables (populated by deploy-local.sh) -----------
    extraEnvVars:
      - name: GITHUB_APP_ID
        valueFrom:
          secretKeyRef:
            name: rhdh-github-app
            key: app-id
            optional: true
      - name: GITHUB_APP_CLIENT_ID
        valueFrom:
          secretKeyRef:
            name: rhdh-github-app
            key: client-id
            optional: true
      - name: GITHUB_APP_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: rhdh-github-app
            key: client-secret
            optional: true
      - name: GITHUB_APP_PRIVATE_KEY
        valueFrom:
          secretKeyRef:
            name: rhdh-github-app
            key: private-key
            optional: true

    appConfig:
      app:
        title: "Three Horizons — Developer Hub (Local)"
        baseUrl: http://localhost:7007

      backend:
        baseUrl: http://localhost:7007
        database:
          client: pg
          connection:
            host: postgresql.databases.svc.cluster.local
            port: 5432
            user: postgres
            password: demo-postgres-2026

      # -- Authentication -----------------------------------------------------
      # Guest mode is always enabled as fallback.
      # GitHub App auth activates when the rhdh-github-app secret exists.
      auth:
        environment: development
        providers:
          guest:
            dangerouslyAllowOutsideDevelopment: true
          github:
            development:
              clientId: ${GITHUB_APP_CLIENT_ID}
              clientSecret: ${GITHUB_APP_CLIENT_SECRET}

      # -- GitHub Integration --------------------------------------------------
      integrations:
        github:
          - host: github.com
            apps:
              - appId: ${GITHUB_APP_ID}
                clientId: ${GITHUB_APP_CLIENT_ID}
                clientSecret: ${GITHUB_APP_CLIENT_SECRET}
                privateKey: ${GITHUB_APP_PRIVATE_KEY}

      # -- Catalog -------------------------------------------------------------
      catalog:
        rules:
          - allow: [Component, System, API, Resource, Location, Template]
        locations:
          - type: url
            target: https://github.com/paulanunes85/three-horizons-accelerator-v4/blob/main/golden-paths/h1-foundation/*/template.yaml
            rules:
              - allow: [Template]
          - type: url
            target: https://github.com/paulanunes85/three-horizons-accelerator-v4/blob/main/golden-paths/h2-enhancement/*/template.yaml
            rules:
              - allow: [Template]
          - type: url
            target: https://github.com/paulanunes85/three-horizons-accelerator-v4/blob/main/golden-paths/h3-innovation/*/template.yaml
            rules:
              - allow: [Template]

      # -- TechDocs ------------------------------------------------------------
      techdocs:
        builder: local
        generator:
          runIn: local
        publisher:
          type: local

    service:
      type: NodePort
      ports:
        backend: 7007
        targetPort: 7007
        nodePort: 30700

  postgresql:
    enabled: false  # Using external PostgreSQL from databases namespace
